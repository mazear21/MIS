{% extends 'base.html' %} {% block title %}Add Homework - MIS System{% endblock %} {% block content
%}
<div class="container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <h2><i class="bi bi-journal-plus me-2"></i>Add Homework</h2>
        <p>Create a new homework assignment</p>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('teacher_homework') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Back
        </a>
      </div>
    </div>
  </div>

  <!-- Add Homework Form -->
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header"><i class="bi bi-journal-text me-2"></i>Homework Details</div>
        <div class="card-body p-4">
          <form method="POST" action="{{ url_for('teacher_add_homework') }}">
            <!-- Subject Selection -->
            <div class="mb-3">
              <label class="form-label">Subject <span class="text-danger">*</span></label>
              <select id="subjectSelect" class="form-select" required>
                <option value="">Select subject...</option>
                {% for subject_name in unique_subjects %}
                <option value="{{ subject_name }}">{{ subject_name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Class Checkboxes (shown after subject selection) -->
            <div id="classCheckboxes" class="mb-3" style="display: none">
              <label class="form-label">Assign to Classes <span class="text-danger">*</span></label>
              <div class="d-flex gap-2 mb-2">
                <button type="button" id="selectAll" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-check-all me-1"></i>Select All
                </button>
                <button type="button" id="deselectAll" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-x-lg me-1"></i>Deselect All
                </button>
                <div class="btn-group" role="group">
                  <button
                    type="button"
                    id="shiftMorning"
                    class="btn btn-sm btn-primary shift-btn active"
                  >
                    <i class="bi bi-sun me-1"></i>Morning
                  </button>
                  <button
                    type="button"
                    id="shiftNight"
                    class="btn btn-sm btn-outline-primary shift-btn"
                  >
                    <i class="bi bi-moon me-1"></i>Night
                  </button>
                </div>
              </div>
              <div id="checkboxContainer" class="row g-2">
                <!-- Checkboxes will be populated by JavaScript -->
              </div>
              <small class="text-muted mt-2 d-block"
                >Select one or more classes to assign this homework</small
              >
            </div>

            <div class="mb-3">
              <label class="form-label">Title <span class="text-danger">*</span></label>
              <input
                type="text"
                name="title"
                class="form-control"
                required
                placeholder="e.g., Chapter 5 Exercises"
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea
                name="description"
                class="form-control"
                rows="4"
                placeholder="Describe the homework assignment..."
              ></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Due Date <span class="text-danger">*</span></label>
              <input type="date" name="due_date" class="form-control" required />
            </div>

            <hr class="my-4" />
            <div class="d-flex justify-content-end gap-2">
              <a href="{{ url_for('teacher_homework') }}" class="btn btn-outline-secondary"
                >Cancel</a
              >
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i>Create Homework
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Store subjects data from server with shift info
  const subjectsData = [
    {% for subject in subjects %}
    {
      id: {{ subject.id }},
      assignment_id: {{ subject.assignment_id }},
      name: "{{ subject.name }}",
      class_id: {{ subject.class_id }},
      class_name: "{{ subject.class_name }}",
      shift: "{{ subject.shift | default('morning') }}".toLowerCase()
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  // Helper function to format class name (remove Year, show Sem + Section)
  function formatClassName(className) {
    // Input: "Year 1 - Sem 1 - Section A - Morning"
    // Output: "Sem 1 - Class A"
    const parts = className.split(' - ');
    if (parts.length >= 3) {
      const part2 = parts[2].replace(/Section\s+/i, 'Class ');
      return `${parts[1]} - ${part2}`;
    }
    return className.replace(/Section\s+/i, 'Class ');
  }

  const subjectSelect = document.getElementById('subjectSelect');
  const classCheckboxes = document.getElementById('classCheckboxes');
  const checkboxContainer = document.getElementById('checkboxContainer');
  const selectAllBtn = document.getElementById('selectAll');
  const deselectAllBtn = document.getElementById('deselectAll');
  const shiftMorningBtn = document.getElementById('shiftMorning');
  const shiftNightBtn = document.getElementById('shiftNight');

  let currentShift = 'morning';
  let currentSubject = '';

  // Function to render checkboxes based on subject and shift
  function renderCheckboxes() {
    if (!currentSubject) {
      classCheckboxes.style.display = 'none';
      checkboxContainer.innerHTML = '';
      return;
    }

    // Filter subjects by selected name and shift
    const matchingSubjects = subjectsData.filter(s =>
      s.name === currentSubject && s.shift === currentShift
    );

    if (matchingSubjects.length === 0) {
      checkboxContainer.innerHTML = '<div class="col-12 text-muted"><i class="bi bi-info-circle me-1"></i>No classes found for this shift</div>';
    } else {
      // Generate checkboxes with formatted class name (unchecked by default)
      checkboxContainer.innerHTML = matchingSubjects.map(subject => `
        <div class="col-md-6">
          <div class="form-check class-checkbox-item">
            <input
              class="form-check-input class-checkbox"
              type="checkbox"
              name="assignment_ids"
              value="${subject.assignment_id}"
              id="assignment_${subject.assignment_id}"
            >
            <label class="form-check-label" for="assignment_${subject.assignment_id}">
              <i class="bi bi-mortarboard me-1"></i>${formatClassName(subject.class_name)}
            </label>
          </div>
        </div>
      `).join('');
    }

    classCheckboxes.style.display = 'block';
  }

  // When subject is selected
  subjectSelect.addEventListener('change', function() {
    currentSubject = this.value;
    renderCheckboxes();
  });

  // Shift toggle buttons
  shiftMorningBtn.addEventListener('click', function() {
    currentShift = 'morning';
    shiftMorningBtn.classList.remove('btn-outline-primary');
    shiftMorningBtn.classList.add('btn-primary', 'active');
    shiftNightBtn.classList.remove('btn-primary', 'active');
    shiftNightBtn.classList.add('btn-outline-primary');
    renderCheckboxes();
  });

  shiftNightBtn.addEventListener('click', function() {
    currentShift = 'night';
    shiftNightBtn.classList.remove('btn-outline-primary');
    shiftNightBtn.classList.add('btn-primary', 'active');
    shiftMorningBtn.classList.remove('btn-primary', 'active');
    shiftMorningBtn.classList.add('btn-outline-primary');
    renderCheckboxes();
  });

  // Select All button
  selectAllBtn.addEventListener('click', function() {
    document.querySelectorAll('.class-checkbox').forEach(cb => cb.checked = true);
  });

  // Deselect All button
  deselectAllBtn.addEventListener('click', function() {
    document.querySelectorAll('.class-checkbox').forEach(cb => cb.checked = false);
  });

  // Form validation - ensure at least one checkbox is selected
  document.querySelector('form').addEventListener('submit', function(e) {
    const checkedBoxes = document.querySelectorAll('.class-checkbox:checked');
    if (checkedBoxes.length === 0) {
      e.preventDefault();
      alert('Please select at least one class for the homework assignment.');
    }
  });
</script>

<style>
  .class-checkbox-item {
    padding: 10px 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
  }
  .class-checkbox-item:hover {
    background: #e7f1ff;
    border-color: #0000ff;
  }
  .class-checkbox-item .form-check-input:checked + .form-check-label {
    color: #0000ff;
    font-weight: 500;
  }
  .class-checkbox-item .form-check-input:checked {
    background-color: #0000ff;
    border-color: #0000ff;
  }
</style>
{% endblock %}
