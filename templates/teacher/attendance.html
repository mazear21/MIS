{% extends 'base.html' %} {% block title %}Attendance - MIS System{% endblock %} {% block content %}
<div class="container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <h2><i class="bi bi-calendar-check me-2"></i>Attendance Management</h2>
        <p>Take and manage student attendance</p>
      </div>
    </div>
  </div>

  <!-- Subject Selection -->
  <div class="card">
    <div class="card-header"><i class="bi bi-journal-bookmark me-2"></i>Select Subject</div>
    <div class="card-body">
      {% if grouped_subjects %}
      <div class="row">
        {% for subject_name, subject_data in grouped_subjects.items() %}
        <div class="col-md-4 mb-3">
          <div
            class="card h-100 subject-card"
            data-bs-toggle="modal"
            data-bs-target="#filterModal"
            data-subject-name="{{ subject_name }}"
            data-subject-key="{{ loop.index }}"
          >
            <div class="card-body text-center">
              <i class="bi bi-journal-bookmark text-navy" style="font-size: 2.5rem"></i>
              <h5 class="mt-3 mb-2 text-navy">{{ subject_name }}</h5>
              <div class="text-muted small">
                <span class="badge bg-primary me-1"
                  >{{ subject_data.classes | length }} Class(es)</span
                >
              </div>
            </div>
            <div class="card-footer bg-light text-center">
              <small class="text-muted"
                ><i class="bi bi-hand-index me-1"></i>Click to select class</small
              >
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Store classes data in a script tag -->
      <script id="subjectsData" type="application/json">
        {
          {% for subject_name, subject_data in grouped_subjects.items() %}
          "{{ loop.index }}": {{ subject_data.classes | tojson }}{% if not loop.last %},{% endif %}
          {% endfor %}
        }
      </script>
      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-journal-bookmark text-muted" style="font-size: 4rem"></i>
        <h5 class="mt-3">No Subjects Assigned</h5>
        <p class="text-muted">Contact admin to assign subjects to you.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Class Selection Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-navy text-white">
        <h5 class="modal-title">
          <i class="bi bi-funnel me-2"></i>
          <span id="modalSubjectName">Select Class</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Choose which class to take attendance for:</p>
        <div id="classOptions">
          <!-- Filled dynamically -->
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .subject-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
  }
  .subject-card:hover {
    border-color: #334155;
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }
  .class-option {
    display: block;
    padding: 15px;
    margin-bottom: 10px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    text-decoration: none;
    color: inherit;
    transition: all 0.15s ease;
  }
  .class-option:hover {
    border-color: #334155;
    background: #f8fafc;
    color: inherit;
  }
  .class-option .shift-badge {
    font-size: 1.2rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('filterModal');
    const modalTitle = document.getElementById('modalSubjectName');
    const classOptions = document.getElementById('classOptions');

    // Load subjects data from script tag
    const subjectsDataEl = document.getElementById('subjectsData');
    let subjectsData = {};
    if (subjectsDataEl) {
      try {
        subjectsData = JSON.parse(subjectsDataEl.textContent);
      } catch (e) {
        console.error('Error parsing subjects data:', e);
      }
    }

    modal.addEventListener('show.bs.modal', function (event) {
      const card = event.relatedTarget;
      const subjectName = card.dataset.subjectName;
      const subjectKey = card.dataset.subjectKey;

      const classes = subjectsData[subjectKey] || [];

      modalTitle.textContent = subjectName;

      let html = '';
      classes.forEach((cls) => {
        const shiftIcon =
          cls.shift === 'morning'
            ? '<i class="bi bi-sun text-warning"></i>'
            : '<i class="bi bi-moon-stars text-primary"></i>';
        const shiftLabel = cls.shift === 'morning' ? 'Morning' : 'Night';
        html += `
                <a href="/teacher/attendance/take/${cls.subject_id}" class="class-option">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Year ${cls.year} - Class ${cls.section || 'All'}</strong>
                            <br>
                            <small class="text-muted">${shiftIcon} ${shiftLabel}</small>
                        </div>
                    </div>
                </a>
            `;
      });

      classOptions.innerHTML = html;
    });
  });
</script>
{% endblock %}
