{% extends 'base.html' %} {% block title %}Attendance Logs - {{ subject.name }}{% endblock %} {%
block content %}
<style>
  .date-card {
    border: 2px solid #0000ff;
    border-radius: 10px;
    margin-bottom: 12px;
    overflow: hidden;
    transition: all 0.2s;
  }
  .date-card:hover {
    box-shadow: 0 4px 12px rgba(43, 87, 154, 0.2);
  }
  .date-header {
    background: #0000ff;
    color: white;
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .date-header:hover {
    background: #3565a8;
  }
  .date-header .date-title {
    font-weight: 600;
    font-size: 1rem;
  }
  .date-header .date-stats {
    display: flex;
    gap: 8px;
  }
  .date-header .stat-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .stat-present {
    background: #2b7a4b;
  }
  .stat-absent {
    background: #c53030;
  }
  .stat-late {
    background: #c9a962;
    color: #0000cc;
  }
  .stat-excused {
    background: #5a8ac4;
  }
  .date-header .chevron {
    transition: transform 0.3s;
  }
  .date-header.collapsed .chevron {
    transform: rotate(-90deg);
  }
  .date-content {
    background: white;
  }
  .student-row {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    border-bottom: 1px solid #e2e8f0;
  }
  .student-row:last-child {
    border-bottom: none;
  }
  .student-row:hover {
    background: #f8fafc;
  }
  .student-num {
    width: 40px;
    color: #64748b;
    font-size: 0.85rem;
  }
  .student-id {
    width: 100px;
    color: #0000ff;
    font-weight: 500;
  }
  .student-name {
    flex: 1;
    font-weight: 500;
  }
  .student-status {
    width: 80px;
    text-align: center;
  }
  .filter-card {
    background: #e8f0f8;
    border: 1px solid #d1e0f0;
    margin-bottom: 20px;
  }
</style>

<div class="container-fluid">
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <h2><i class="bi bi-journal-text me-2"></i>Attendance Logs</h2>
        <p class="mb-0">{{ subject.name }} - {{ subject.class_name|replace_section }}</p>
      </div>
      <div class="col-auto">
        <a
          href="{{ url_for('teacher_take_attendance', subject_id=subject.id) }}"
          class="btn btn-primary me-2"
        >
          <i class="bi bi-plus-circle me-1"></i>Take Attendance
        </a>
        <a href="{{ url_for('teacher_attendance') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Back
        </a>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#logs">
        <i class="bi bi-calendar-week me-1"></i>By Date ({{ logs_by_date|length }} days)
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#summary">
        <i class="bi bi-bar-chart me-1"></i>Summary
      </a>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Logs By Date Tab -->
    <div class="tab-pane fade show active" id="logs">
      {% if logs_by_date %}
      <div class="accordion" id="attendanceAccordion">
        {% for date_str, records in logs_by_date.items() %} {% set present_count = records |
        selectattr('status', 'eq', 'present') | list | length %} {% set absent_count = records |
        selectattr('status', 'eq', 'absent') | list | length %} {% set late_count = records |
        selectattr('status', 'eq', 'late') | list | length %} {% set excused_count = records |
        selectattr('status', 'eq', 'excused') | list | length %}

        <div class="date-card">
          <div
            class="date-header collapsed"
            data-bs-toggle="collapse"
            data-bs-target="#date-{{ loop.index }}"
          >
            <div class="d-flex align-items-center">
              <i class="bi bi-calendar-event me-2"></i>
              <span class="date-title">{{ date_str }}</span>
              <span class="ms-3 text-white-50">({{ records|length }} students)</span>
            </div>
            <div class="d-flex align-items-center">
              <div class="date-stats">
                {% if present_count > 0 %}
                <span class="stat-badge stat-present">P: {{ present_count }}</span>
                {% endif %} {% if absent_count > 0 %}
                <span class="stat-badge stat-absent">A: {{ absent_count }}</span>
                {% endif %} {% if late_count > 0 %}
                <span class="stat-badge stat-late">L: {{ late_count }}</span>
                {% endif %} {% if excused_count > 0 %}
                <span class="stat-badge stat-excused">E: {{ excused_count }}</span>
                {% endif %}
              </div>
              <i class="bi bi-chevron-down chevron ms-3"></i>
            </div>
          </div>
          <div id="date-{{ loop.index }}" class="collapse" data-bs-parent="#attendanceAccordion">
            <div class="date-content">
              {% for record in records %}
              <div class="student-row">
                <span class="student-num">{{ loop.index }}</span>
                <span class="student-id">{{ record.student_number or '-' }}</span>
                <span class="student-name">{{ record.student_name }}</span>
                <span class="student-status">
                  {% if record.status == 'present' %}
                  <span class="badge bg-success">Present</span>
                  {% elif record.status == 'absent' %}
                  <span class="badge bg-danger">Absent</span>
                  {% elif record.status == 'late' %}
                  <span class="badge bg-warning text-dark">Late</span>
                  {% else %}
                  <span class="badge bg-info">Excused</span>
                  {% endif %}
                </span>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="card">
        <div class="card-body text-center py-5 text-muted">
          <i class="bi bi-inbox fs-1 d-block mb-3"></i>
          <h5>No Attendance Records Yet</h5>
          <p class="mb-3">Start taking attendance to see records here.</p>
          <a
            href="{{ url_for('teacher_take_attendance', subject_id=subject.id) }}"
            class="btn btn-primary"
          >
            <i class="bi bi-plus-circle me-1"></i>Take Attendance
          </a>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Summary Tab -->
    <div class="tab-pane fade" id="summary">
      <div class="card filter-card mb-3">
        <div class="card-body py-3">
          <div class="row g-2 align-items-center">
            <div class="col-md-6">
              <label class="form-label small mb-1 fw-bold">
                <i class="bi bi-search me-1"></i>Search Student
              </label>
              <input
                type="text"
                id="summarySearchInput"
                class="form-control"
                placeholder="Type first name... (e.g., 'h' for Hassan, 'a' for Ali)"
                autocomplete="off"
              />
              <small class="text-muted">Searches by first name or student ID</small>
            </div>
            <div class="col-md-3">
              <button
                type="button"
                class="btn btn-outline-dark w-100 mt-4"
                onclick="
                  document.getElementById('summarySearchInput').value = '';
                  filterSummaryTable();
                "
              >
                <i class="bi bi-x-circle me-1"></i>Clear
              </button>
            </div>
            <div class="col-md-3 text-end">
              <small class="text-muted d-block mt-4">
                <span id="summaryResultCount">{{ summary|length if summary else 0 }}</span> of
                <span id="summaryTotalCount">{{ summary|length if summary else 0 }}</span> students
              </small>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-people me-2"></i>Attendance Summary by Student
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0" id="summaryTable">
            <thead class="table-dark">
              <tr>
                <th>Student ID</th>
                <th>Student Name</th>
                <th class="text-center">Total</th>
                <th class="text-center">Present</th>
                <th class="text-center">Absent</th>
                <th class="text-center">Late</th>
                <th class="text-center">Excused</th>
                <th class="text-center">Rate</th>
              </tr>
            </thead>
            <tbody id="summaryTableBody">
              {% if summary %} {% for s in summary %} {% set attendance_pct = ((s.present_count +
              s.late_count) / s.total_classes * 100) if s.total_classes > 0 else 0 %}
              <tr
                class="summary-row"
                data-student-name="{{ s.student_name|lower }}"
                data-student-id="{{ s.student_number|lower }}"
              >
                <td>{{ s.student_number or '-' }}</td>
                <td><strong>{{ s.student_name }}</strong></td>
                <td class="text-center">{{ s.total_classes }}</td>
                <td class="text-center">
                  <span class="badge bg-success">{{ s.present_count }}</span>
                </td>
                <td class="text-center">
                  <span class="badge bg-danger">{{ s.absent_count }}</span>
                </td>
                <td class="text-center">
                  <span class="badge bg-warning text-dark">{{ s.late_count }}</span>
                </td>
                <td class="text-center">
                  <span class="badge bg-info">{{ s.excused_count }}</span>
                </td>
                <td class="text-center">
                  {% if attendance_pct >= 80 %}
                  <span class="badge bg-success">{{ "%.0f"|format(attendance_pct) }}%</span>
                  {% elif attendance_pct >= 60 %}
                  <span class="badge bg-warning text-dark"
                    >{{ "%.0f"|format(attendance_pct) }}%</span
                  >
                  {% else %}
                  <span class="badge bg-danger">{{ "%.0f"|format(attendance_pct) }}%</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %} {% else %}
              <tr id="noDataRow">
                <td colspan="8" class="text-center py-4 text-muted">
                  <i class="bi bi-inbox fs-2 d-block mb-2"></i>
                  No attendance data yet
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div
          id="noResultsMessage"
          class="card-body text-center py-4 text-muted"
          style="display: none"
        >
          <i class="bi bi-search fs-2 d-block mb-2"></i>
          <h5>No students found</h5>
          <p class="mb-0">Try a different search term</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Toggle chevron rotation on collapse
  document.querySelectorAll('.date-header').forEach((header) => {
    header.addEventListener('click', function () {
      this.classList.toggle('collapsed');
    });
  });

  // Smart search function for Summary tab
  const summarySearchInput = document.getElementById('summarySearchInput');
  const summaryRows = document.querySelectorAll('.summary-row');
  const summaryResultCount = document.getElementById('summaryResultCount');
  const summaryTotalCount = document.getElementById('summaryTotalCount');
  const noResultsMessage = document.getElementById('noResultsMessage');
  const summaryTable = document.getElementById('summaryTable');

  // Set initial total count
  if (summaryTotalCount) {
    summaryTotalCount.textContent = summaryRows.length;
    summaryResultCount.textContent = summaryRows.length;
  }

  function filterSummaryTable() {
    const searchTerm = summarySearchInput.value.toLowerCase().trim();

    if (!searchTerm) {
      // Show all rows
      summaryRows.forEach((row) => (row.style.display = ''));
      summaryResultCount.textContent = summaryRows.length;
      noResultsMessage.style.display = 'none';
      summaryTable.style.display = '';
      return;
    }

    // Split search term into words for smart matching
    const searchWords = searchTerm.split(/\s+/).filter((w) => w.length > 0);

    let visibleCount = 0;
    summaryRows.forEach((row) => {
      const studentName = row.dataset.studentName || '';
      const studentId = row.dataset.studentId || '';

      // Split student name into words - only match FIRST name
      const nameWords = studentName.split(/\s+/);
      const firstName = nameWords[0] || '';

      // For single search word, match first name or student ID
      if (searchWords.length === 1) {
        const searchWord = searchWords[0];
        const firstNameMatch = firstName.startsWith(searchWord);
        const idMatch = studentId.includes(searchWord);

        if (firstNameMatch || idMatch) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      } else {
        // For multiple words, match all words in order (first name, last name, etc.)
        const matches = searchWords.every((searchWord, index) => {
          if (index < nameWords.length) {
            return nameWords[index].startsWith(searchWord);
          }
          return false;
        });

        if (matches) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      }
    });

    summaryResultCount.textContent = visibleCount;

    // Show/hide no results message
    if (visibleCount === 0) {
      noResultsMessage.style.display = 'block';
      summaryTable.style.display = 'none';
    } else {
      noResultsMessage.style.display = 'none';
      summaryTable.style.display = '';
    }
  }

  // Add event listener for real-time search
  if (summarySearchInput) {
    summarySearchInput.addEventListener('input', filterSummaryTable);

    // Focus search input when Summary tab is shown
    document.querySelector('a[href="#summary"]').addEventListener('shown.bs.tab', function () {
      summarySearchInput.focus();
    });
  }
</script>
{% endblock %}
