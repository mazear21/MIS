{% extends 'base.html' %} {% block title %}Dashboard - Student{% endblock %} {% block content %}
<div class="container" style="max-width: 100%; overflow-x: hidden">
  <!-- Welcome Header -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card bg-primary text-white shadow-sm">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col">
              <h5 class="mb-1">
                <i class="bi bi-mortarboard me-2"></i>Welcome, {{ student.full_name }}!
              </h5>
              <p class="mb-0 opacity-75" style="font-size: 0.85rem">
                <i class="bi bi-hash me-1"></i>{{ student.student_number or 'N/A' }}
                <span class="mx-2">|</span>
                <i class="bi bi-calendar3 me-1"></i>{{ (student.class_name|replace_section) or 'No
                Semester' }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row mb-3">
    <div class="col-6 col-md-3 mb-2">
      <div class="card shadow-sm h-100 border-0">
        <div class="card-body text-center py-2">
          <i class="bi bi-calendar-check text-success" style="font-size: 1.5rem"></i>
          <h5 class="mb-0 mt-1">
            {{ attendance|selectattr('status', 'equalto', 'present')|list|length }}
          </h5>
          <small class="text-muted" style="font-size: 0.7rem">Present</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card shadow-sm h-100 border-0">
        <div class="card-body text-center py-2">
          <i class="bi bi-clipboard-data text-primary" style="font-size: 1.5rem"></i>
          <h5 class="mb-0 mt-1">{{ grades|length }}</h5>
          <small class="text-muted" style="font-size: 0.7rem">Grades</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card shadow-sm h-100 border-0">
        <div class="card-body text-center py-2">
          <i class="bi bi-journal-text text-warning" style="font-size: 1.5rem"></i>
          <h5 class="mb-0 mt-1">{{ homework|length }}</h5>
          <small class="text-muted" style="font-size: 0.7rem">Homework</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card shadow-sm h-100 border-0">
        <div class="card-body text-center py-2">
          <i class="bi bi-book text-info" style="font-size: 1.5rem"></i>
          <h5 class="mb-0 mt-1">{{ weekly_topics|length }}</h5>
          <small class="text-muted" style="font-size: 0.7rem">Topics</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column -->
    <div class="col-lg-6">
      <!-- Attendance -->
      <div class="card shadow-sm mb-3 border-0">
        <div class="card-header bg-white border-0 py-2">
          <i class="bi bi-calendar-check me-2 text-primary"></i
          ><strong style="font-size: 0.85rem">Attendance</strong>
        </div>
        <div class="card-body p-0">
          {% if attendance %}
          <div class="table-responsive" style="max-height: 200px; overflow-y: auto">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Subject</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for record in attendance[:8] %}
                <tr>
                  <td>{{ record.date }}</td>
                  <td>{{ record.subject_name }}</td>
                  <td>
                    {% if record.status == 'present' %}
                    <span class="badge bg-success">Present</span>
                    {% elif record.status == 'absent' %}
                    <span class="badge bg-danger">Absent</span>
                    {% elif record.status == 'late' %}
                    <span class="badge bg-warning text-dark">Late</span>
                    {% else %}
                    <span class="badge bg-secondary">Excused</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-4 text-muted">
            <i class="bi bi-calendar-x fs-3"></i>
            <p class="mb-0 mt-2">No attendance records</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Homework -->
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white border-0 py-3">
          <i class="bi bi-journal-text me-2 text-primary"></i><strong>Homework</strong>
        </div>
        <div class="card-body p-0">
          {% if homework %}
          <div class="list-group list-group-flush" style="max-height: 260px; overflow-y: auto">
            {% for hw in homework %}
            <div class="list-group-item border-0 border-bottom">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>{{ hw.title }}</strong>
                  <small class="text-muted d-block">{{ hw.subject_name }}</small>
                </div>
                {% if hw.due_date.isoformat() < today %}
                <span class="badge bg-secondary align-self-center">Past</span>
                {% else %}
                <span class="badge bg-primary align-self-center">{{ hw.due_date }}</span>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4 text-muted">
            <i class="bi bi-journal-x fs-3"></i>
            <p class="mb-0 mt-2">No homework</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-6">
      <!-- Grades -->
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white border-0 py-3">
          <i class="bi bi-clipboard-data me-2 text-primary"></i><strong>Grades</strong>
        </div>
        <div class="card-body p-0">
          {% if grades %}
          <div class="table-responsive" style="max-height: 260px; overflow-y: auto">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Subject</th>
                  <th>Title</th>
                  <th>Score</th>
                </tr>
              </thead>
              <tbody>
                {% for grade in grades[:8] %}
                <tr>
                  <td>{{ grade.subject_name }}</td>
                  <td>
                    {{ grade.title }} <small class="text-muted">({{ grade.grade_type }})</small>
                  </td>
                  <td>
                    {% set pct = (grade.score / grade.max_score * 100) if grade.max_score else 0 %}
                    <strong
                      class="{% if pct >= 60 %}text-success{% elif pct >= 40 %}text-warning{% else %}text-danger{% endif %}"
                    >
                      {{ grade.score }}/{{ grade.max_score }}
                    </strong>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-4 text-muted">
            <i class="bi bi-clipboard-x fs-3"></i>
            <p class="mb-0 mt-2">No grades yet</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Weekly Topics -->
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white border-0 py-3">
          <i class="bi bi-list-task me-2 text-primary"></i><strong>Topics</strong>
        </div>
        <div class="card-body p-0">
          {% if weekly_topics %}
          <div class="list-group list-group-flush" style="max-height: 260px; overflow-y: auto">
            {% for topic in weekly_topics %}
            <div class="list-group-item border-0 border-bottom d-flex align-items-center">
              <span class="badge bg-primary me-2">W{{ topic.week_number }}</span>
              <div>
                <strong>{{ topic.topic }}</strong>
                <small class="text-muted d-block">{{ topic.subject_name }}</small>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4 text-muted">
            <i class="bi bi-list-ul fs-3"></i>
            <p class="mb-0 mt-2">No topics yet</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- My Schedule -->
  <div class="scheduler-wrapper">
    <div class="scheduler-header">
      <div class="scheduler-brand">
        <div class="brand-icon"><i class="bi bi-calendar-week"></i></div>
        <div class="brand-text">
          <h5>My Weekly Schedule</h5>
          <span>{{ student.class_name|replace_section }}</span>
        </div>
      </div>
      {% if schedule_data %}
      <div class="scheduler-controls">
        <button class="ctrl-btn" onclick="window.print()" title="Print">
          <i class="bi bi-printer"></i>
        </button>
      </div>
      {% endif %}
    </div>

    {% if schedule_data %}
    <div class="scheduler-grid-area">
      <table class="scheduler-table" id="scheduleTable">
        <thead>
          <tr>
            <th><span class="day-full">Sunday</span><span class="day-abbr">Sun</span></th>
            <th><span class="day-full">Monday</span><span class="day-abbr">Mon</span></th>
            <th><span class="day-full">Tuesday</span><span class="day-abbr">Tue</span></th>
            <th><span class="day-full">Wednesday</span><span class="day-abbr">Wed</span></th>
            <th><span class="day-full">Thursday</span><span class="day-abbr">Thu</span></th>
          </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
      </table>
    </div>

    <script>
      const scheduleData = {{ schedule_data | tojson | safe }};

      function renderSchedule() {
        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = '';

        if (!scheduleData || scheduleData.length === 0) {
          tbody.innerHTML = '<tr><td colspan=\"5\" class=\"text-center text-muted py-4\">No schedule available</td></tr>';
          return;
        }

        const maxRow = Math.max(...scheduleData.map(e => e.row)) + 1;

        for (let r = 0; r < maxRow; r++) {
          const tr = document.createElement('tr');
          for (let c = 0; c < 5; c++) {
            const entry = scheduleData.find(e => e.row === r && e.col === c);
            const td = document.createElement('td');

            if (entry) {
              if (entry.isBreak) {
                td.className = 'break-cell';
                td.innerHTML = `<div class=\"break-label\">BREAK</div>`;
              } else {
                td.className = 'has-class';
                const lectureType = entry.lectureType || 'theory';
                const bgColor = getBgColor(entry.subject);
                const teacher = lectureType === 'practical' ? (entry.practicalTeacher || entry.teacher) : (entry.teacher || '');
                const startTime = lectureType === 'practical' ? (entry.practicalStartTime || entry.startTime) : (entry.theoryStartTime || entry.startTime);
                const endTime = lectureType === 'practical' ? (entry.practicalEndTime || entry.endTime) : (entry.theoryEndTime || entry.endTime);

                td.innerHTML = `
                  <div class=\"class-card\" style=\"background: ${bgColor};\">
                    <span class=\"class-type-badge\">${lectureType === 'practical' ? 'P' : 'T'}</span>
                    <div class=\"class-subject\">${entry.subject || ''}</div>
                    ${teacher ? `<div class=\"class-teacher\">${teacher}</div>` : ''}
                    ${entry.room ? `<div class=\"class-room\">Room ${entry.room}</div>` : ''}
                  </div>
                `;
              }
            } else {
              td.innerHTML = '<div class=\"empty-cell\">—</div>';
            }

            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
      }

      function getBgColor(subject) {
        const colors = [
          '#E0F2FE', '#DBEAFE', '#E0E7FF', '#EDE9FE', '#FCE7F3',
          '#FEF3C7', '#D1FAE5', '#FED7AA', '#E9D5FF', '#FBCFE8',
          '#BAE6FD', '#C7D2FE', '#FECACA', '#FDE68A', '#D9F99D'
        ];
        let hash = 0;
        for (let i = 0; i < subject.length; i++) {
          hash = subject.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
      }

      renderSchedule();
    </script>
    {% else %}
    <div class="text-center py-5">
      <i class="bi bi-calendar-x text-muted" style="font-size: 4rem"></i>
      <h5 class="mt-3">No Schedule Available</h5>
      <p class="text-muted">
        Your class schedule hasn't been created yet. Please contact your administrator.
      </p>
    </div>
    {% endif %}
  </div>

  <style>
    .scheduler-wrapper {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }
    .scheduler-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #0000ff;
      color: #fff;
    }
    .scheduler-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand-icon {
      width: 42px;
      height: 42px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .brand-text h5 {
      margin: 0;
      font-weight: 600;
      font-size: 1.05rem;
    }
    .brand-text span {
      font-size: 0.75rem;
      opacity: 0.7;
    }
    .scheduler-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ctrl-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
      transition: background 0.2s;
    }
    .ctrl-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .scheduler-grid-area {
      padding: 16px;
      background: #fff;
      overflow-x: auto;
    }
    .scheduler-table {
      width: 100%;
      border-collapse: collapse;
    }
    .scheduler-table th {
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 0.8rem;
      color: #374151;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
    }
    .scheduler-table th .day-abbr {
      display: none;
    }
    .scheduler-table td {
      height: 65px;
      vertical-align: middle;
      background: #fff;
      border: 1px solid #e5e7eb;
      position: relative;
    }
    .scheduler-table td.has-class {
      padding: 2px;
      background: #fff;
      vertical-align: middle;
    }
    .empty-cell {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #d1d5db;
      font-size: 0.8rem;
    }
    .break-cell {
      background: #f9fafb;
      text-align: center;
      vertical-align: middle;
    }
    .break-label {
      display: inline-block;
      padding: 8px 20px;
      background: #fff;
      color: #6b7280;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      letter-spacing: 1px;
    }
    .class-card {
      height: 100%;
      padding: 6px 8px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      border: none;
      min-height: 55px;
    }
    .class-type-badge {
      position: absolute;
      top: 3px;
      right: 3px;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 0.45rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      background: rgba(0, 0, 0, 0.12);
      color: #374151;
    }
    .class-subject {
      font-weight: 700;
      font-size: 0.7rem;
      color: #1e293b;
      margin-bottom: 3px;
      line-height: 1.2;
      text-align: center;
    }
    .class-teacher {
      font-size: 0.6rem;
      color: rgba(0, 0, 0, 0.6);
      text-align: center;
      line-height: 1.1;
    }
    .class-room {
      font-size: 0.55rem;
      opacity: 0.5;
      margin-top: 1px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .scheduler-table th .day-full {
        display: none;
      }
      .scheduler-table th .day-abbr {
        display: inline;
      }
      .class-subject {
        font-size: 0.65rem;
      }
      .class-teacher {
        font-size: 0.55rem;
      }
    }
  </style>
</div>
{% endblock %}
