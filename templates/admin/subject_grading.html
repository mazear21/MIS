{% extends 'base.html' %} {% block title %}Grade Distribution - {{ subject.name }}{% endblock %} {%
block content %}
<div class="container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <h2><i class="bi bi-calculator me-2"></i>Grade Distribution</h2>
        <p class="mb-0">
          <strong>{{ subject.name }}</strong>
          <span class="text-muted ms-2">
            • Semester {{ subject.semester }} {% if subject.shift %}• {{ subject.shift|title }}
            Shift{% endif %}
          </span>
        </p>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('admin_subjects') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Back to Subjects
        </a>
      </div>
    </div>
  </div>

  <!-- Total Weight Status -->
  <div
    class="alert {% if is_valid %}alert-success{% else %}alert-warning{% endif %} d-flex align-items-center"
    role="alert"
  >
    <i
      class="bi {% if is_valid %}bi-check-circle-fill{% else %}bi-exclamation-triangle-fill{% endif %} me-2 fs-5"
    ></i>
    <div class="flex-grow-1">
      <strong>Total Weight: {{ "%.2f"|format(total_weight) }}%</strong>
      {% if is_valid %}
      <span class="ms-2">✓ Complete distribution (100%)</span>
      {% else %}
      <span class="ms-2">⚠ Incomplete - Add more components to reach 100%</span>
      {% endif %}
    </div>
    <div class="progress" style="width: 200px; height: 25px">
      <div
        class="progress-bar {% if is_valid %}bg-success{% elif total_weight > 100 %}bg-danger{% else %}bg-warning{% endif %}"
        role="progressbar"
        style="width: {{ [total_weight, 100]|min }}%"
        aria-valuenow="{{ total_weight }}"
        aria-valuemin="0"
        aria-valuemax="100"
      >
        {{ "%.1f"|format(total_weight) }}%
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Add Component Form -->
    <div class="col-md-4 mb-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-plus-circle me-2"></i>Add Component
        </div>
        <div class="card-body">
          <form
            method="POST"
            action="{{ url_for('admin_add_grade_component', subject_id=subject.id) }}"
            id="addComponentForm"
          >
            <div class="mb-3">
              <label class="form-label">Type <span class="text-danger">*</span></label>
              <select name="component_type" id="componentType" class="form-select" required>
                <option value="">Select type...</option>
                <option value="homework">Homework</option>
                <option value="quiz">Quiz</option>
                <option value="report">Report</option>
                <option value="project">Project</option>
                <option value="exam">Exam</option>
                <option value="midterm">Midterm</option>
                <option value="final">Final</option>
                <option value="lab_report">Lab Report</option>
                <option value="activity">Classroom Activity</option>
                <option value="seminar">Seminar</option>
              </select>
            </div>

            <div class="mb-3" id="midtermStructureDiv" style="display: none">
              <label class="form-label">Midterm Structure <span class="text-danger">*</span></label>
              <div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="midterm_structure" id="midtermSingle" value="single" checked>
                  <label class="form-check-label" for="midtermSingle">
                    Single Exam
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="midterm_structure" id="midtermSplit" value="split">
                  <label class="form-check-label" for="midtermSplit">
                    Split: Practical + Theoretical
                  </label>
                </div>
              </div>
            </div>

            <div class="mb-3" id="splitWeightsDiv" style="display: none">
              <div class="row">
                <div class="col-6">
                  <label class="form-label">Practical Weight % <span class="text-danger">*</span></label>
                  <input
                    type="number"
                    name="practical_weight"
                    id="practicalWeight"
                    class="form-control"
                    step="0.1"
                    min="0"
                    max="100"
                    placeholder="e.g., 15"
                  />
                </div>
                <div class="col-6">
                  <label class="form-label">Theoretical Weight % <span class="text-danger">*</span></label>
                  <input
                    type="number"
                    name="theoretical_weight"
                    id="theoreticalWeight"
                    class="form-control"
                    step="0.1"
                    min="0"
                    max="100"
                    placeholder="e.g., 10"
                  />
                </div>
              </div>
              <small class="text-muted">Max scores will equal the weights (15% = 15 pts, 10% = 10 pts)</small>
            </div>

            <div class="mb-3" id="quantityDiv">
              <label class="form-label">Quantity <span class="text-danger">*</span></label>
              <input
                type="number"
                name="quantity"
                id="quantityInput"
                class="form-control"
                value="1"
                min="1"
                max="20"
                required
              />
              <small class="text-muted"
                >How many items of this type? (e.g., 3 homeworks, 2 quizzes)</small
              >
            </div>

            <div class="mb-3" id="weightDiv">
              <label class="form-label">Total Weight % <span class="text-danger">*</span></label>
              <input
                type="number"
                name="weight_percentage"
                id="weightInput"
                class="form-control"
                step="0.1"
                min="0"
                max="100"
                placeholder="e.g., 10, 15, 20"
                required
              />
              <small class="text-muted">
                <strong>Important:</strong> Max score will EQUAL this weight. (5% \u2192 max 5 pts each). Teachers enter scores out of this number. Remaining:
                <strong>{{ "%.2f"|format(100 - total_weight) }}%</strong>
              </small>
            </div>

            <div class="mb-3">
              <label class="form-label">Display Order</label>
              <input
                type="number"
                name="display_order"
                class="form-control"
                value="{{ components|length }}"
                min="0"
              />
              <small class="text-muted">Lower numbers appear first</small>
            </div>

            {% if total_weight >= 100 %}
            <button type="submit" class="btn btn-primary w-100" disabled>
              <i class="bi bi-plus-lg me-1"></i>Add Component
            </button>
            {% else %}
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-plus-lg me-1"></i>Add Component
            </button>
            {% endif %}
          </form>
        </div>
      </div>

      <!-- Quick Tips -->
      <div class="card mt-3">
        <div class="card-body">
          <h6 class="card-title"><i class="bi bi-lightbulb text-warning me-2"></i>Tips</h6>
          <ul class="small mb-0 ps-3">
            <li>Total weight must equal 100%</li>
            <li>
              <strong>Max score = Weight:</strong> 5% weight = 5 max points, 24% = 24 points
            </li>
            <li><strong>Multiple items:</strong> 3 items @ 15% total = each gets 5% weight & 5 max points</li>
            <li><strong>Split Midterm:</strong> Manually specify Practical and Theoretical weights (e.g., 15% + 10%)</li>
            <li>System auto-numbers items (Homework 1, 2, 3...)</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Components List -->
    <div class="col-md-8">
      <!-- Grade Components Display -->
      <div class="card">
        <div class="card-header bg-light">
          <div class="row align-items-center">
            <div class="col">
              <h5 class="mb-0">
                <i class="bi bi-list-check me-2"></i>Grade Distribution
                {% if components %}
                <span class="badge bg-secondary ms-2">{{ components|length }} components</span>
                {% endif %}
              </h5>
            </div>
            {% if components %}
            <div class="col-auto d-flex align-items-center gap-2">
              <button 
                type="button" 
                class="btn btn-sm btn-outline-secondary" 
                data-bs-toggle="modal" 
                data-bs-target="#reorderModal"
              >
                <i class="bi bi-arrow-down-up me-1"></i>Reorder
              </button>
              <h4 class="mb-0">
                <span class="{% if is_valid %}text-success{% elif total_weight > 100 %}text-danger{% else %}text-warning{% endif %}">
                  {{ "%.1f"|format(total_weight) }}%
                </span>
                <small class="text-muted"> / 100%</small>
              </h4>
            </div>
            {% endif %}
          </div>
          {% if components %}
          <div class="progress mt-2" style="height: 8px;">
            <div 
              class="progress-bar {% if is_valid %}bg-success{% elif total_weight > 100 %}bg-danger{% else %}bg-warning{% endif %}"
              role="progressbar" 
              style="width: {{ [total_weight, 100]|min }}%"
              aria-valuenow="{{ total_weight }}" 
              aria-valuemin="0" 
              aria-valuemax="100"
            ></div>
          </div>
          <small class="{% if is_valid %}text-success{% elif total_weight > 100 %}text-danger{% else %}text-muted{% endif %} d-block mt-1">
            {% if is_valid %}
              <i class="bi bi-check-circle me-1"></i>Complete (100%)
            {% elif total_weight > 100 %}
              <i class="bi bi-exclamation-triangle me-1"></i>Exceeds by {{ "%.1f"|format(total_weight - 100) }}%
            {% else %}
              <i class="bi bi-info-circle me-1"></i>{{ "%.1f"|format(100 - total_weight) }}% remaining
            {% endif %}
          </small>
          {% endif %}
        </div>
        
        <div class="card-body">
          {% if components %}
          
          {% set ns = namespace(seen_types=[]) %}
          {% for component in components %}
            {% if component.component_type not in ns.seen_types %}
              {% set _ = ns.seen_types.append(component.component_type) %}
              {% set type = component.component_type %}
              {% set items = components | selectattr('component_type', 'equalto', type) | list %}
              {% set type_total = items | sum(attribute='weight_percentage') %}
              
              <!-- Category Section -->
              <div class="border rounded mb-3">
                <!-- Category Header -->
              <div class="bg-light border-bottom px-3 py-2">
                <div class="row align-items-center">
                  <div class="col">
                    <span class="badge bg-dark me-2" style="font-weight: 600;">
                      {% if type == 'lab_report' %}LAB REPORT{% else %}{{ type|upper }}{% endif %}
                    </span>
                    <span class="text-muted small">{{ items|length }} item{% if items|length != 1 %}s{% endif %}</span>
                  </div>
                  <div class="col-auto">
                    <strong class="text-dark me-3" style="font-size: 1.1rem;">{{ "%.1f"|format(type_total) }}%</strong>
                    <button 
                      class="btn btn-sm btn-outline-secondary edit-category-btn me-1"
                      title="Edit total weight"
                      data-type="{{ type }}"
                      data-weight="{{ "%.1f"|format(type_total) }}"
                    >
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <form
                      method="POST"
                      action="{{ url_for('admin_delete_grade_category', subject_id=subject.id, component_type=type) }}"
                      class="d-inline"
                      onsubmit="return confirm('Delete all {{ items|length }} {{ type|title }} component(s)?');"
                    >
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete all">
                        <i class="bi bi-trash-fill"></i>
                      </button>
                    </form>
                  </div>
                </div>
              </div>
              
              <!-- Component Items -->
              <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                  <thead class="table-light">
                    <tr class="small">
                      <th style="width: 50%">Component Name</th>
                      <th class="text-center" style="width: 15%">Max Score</th>
                      <th class="text-center" style="width: 15%">Weight %</th>
                      <th class="text-center" style="width: 10%">Order</th>
                      <th class="text-center" style="width: 10%">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for component in items %}
                    <tr>
                      <td>
                        <i class="bi bi-circle-fill text-secondary me-2" style="font-size: 6px;"></i>
                        <strong>{{ component.component_name }}</strong>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-light text-dark border">{{ component.max_score }}</span>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-dark text-white">{{ "%.1f"|format(component.weight_percentage) }}%</span>
                      </td>
                      <td class="text-center text-muted small">#{{ component.display_order }}</td>
                      <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                          <button
                            class="btn btn-outline-secondary edit-comp-btn"
                            title="Edit"
                            data-id="{{ component.id }}"
                            data-type="{{ component.component_type }}"
                            data-name="{{ component.component_name }}"
                            data-max="{{ component.max_score }}"
                            data-weight="{{ component.weight_percentage }}"
                            data-order="{{ component.display_order }}"
                          >
                            <i class="bi bi-pencil"></i>
                          </button>
                          <form
                            method="POST"
                            action="{{ url_for('admin_delete_grade_component', subject_id=subject.id, component_id=component.id) }}"
                            class="d-inline"
                            onsubmit="return confirm('Delete {{ component.component_name }}?');"
                          >
                            <button type="submit" class="btn btn-outline-danger" title="Delete">
                              <i class="bi bi-trash"></i>
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            {% endif %}
          {% endfor %}
          
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-calculator text-muted" style="font-size: 4rem"></i>
            <h5 class="mt-3">No Grade Components Defined</h5>
            <p class="text-muted">
              Start by adding components to create the grading rubric for this subject.
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Single Edit Modal (populated via JS - formatter safe) -->
<div class="modal fade" id="editComponentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Component</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" id="editComponentForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Type</label>
            <select name="component_type" id="editCompType" class="form-select" required>
              <option value="homework">Homework</option>
              <option value="quiz">Quiz</option>
              <option value="report">Report</option>
              <option value="project">Project</option>
              <option value="exam">Exam</option>
              <option value="midterm">Midterm</option>
              <option value="final">Final</option>
              <option value="lab_report">Lab Report</option>
              <option value="activity">Classroom Activity</option>
              <option value="seminar">Seminar</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input
              type="text"
              name="component_name"
              id="editCompName"
              class="form-control"
              required
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Max Score</label>
            <input
              type="number"
              name="max_score"
              id="editCompMax"
              class="form-control"
              step="0.5"
              min="0.5"
              required
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Weight %</label>
            <input
              type="number"
              name="weight_percentage"
              id="editCompWeight"
              class="form-control"
              step="0.1"
              min="0"
              max="100"
              required
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Display Order</label>
            <input
              type="number"
              name="display_order"
              id="editCompOrder"
              class="form-control"
              min="0"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Category Edit Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Category Weight</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" id="editCategoryForm">
        <div class="modal-body">
          <p class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Change the total weight for all <strong id="categoryTypeLabel"></strong> components. 
            The new weight will be distributed equally among all items.
          </p>
          
          <div class="mb-3">
            <label class="form-label">Current Total Weight</label>
            <input
              type="text"
              id="categoryCurrentWeight"
              class="form-control"
              readonly
              disabled
            />
          </div>
          
          <div class="mb-3">
            <label class="form-label">New Total Weight %</label>
            <input
              type="number"
              name="new_total_weight"
              id="categoryNewWeight"
              class="form-control"
              step="0.1"
              min="0.1"
              max="100"
              required
            />
            <small class="text-muted">This will be split equally among all items in this category</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Category</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reorder Components Modal -->
<div class="modal fade" id="reorderModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 450px;">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title mb-0">
          <i class="bi bi-arrow-down-up me-2"></i>Reorder Categories
        </h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('admin_reorder_grade_components', subject_id=subject.id) }}" id="reorderForm">
        <input type="hidden" name="category_order" id="categoryOrderInput" />
        <div class="modal-body py-2 px-3">
          <p class="text-muted mb-2 small">
            <i class="bi bi-hand-index me-1"></i>
            <strong>Drag & drop</strong> to reorder. Top categories appear first.
          </p>
          
          {% if components %}
          <div id="categoryList" class="list-group list-group-flush">
            {% set components_by_type = components | groupby('component_type') %}
            {% for type_group in components_by_type %}
              {% set type = type_group.grouper %}
              {% set items = type_group.list %}
              {% set type_total = items | sum(attribute='weight_percentage') %}
              
              <div 
                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center category-item py-2 px-2" 
                draggable="true"
                data-type="{{ type }}"
                style="cursor: move; border-left: 3px solid #212529;"
              >
                <div class="d-flex align-items-center">
                  <i class="bi bi-grip-vertical text-muted me-2"></i>
                  <span class="badge bg-dark me-2 small">
                    {% if type == 'lab_report' %}LAB REPORT{% else %}{{ type|upper }}{% endif %}
                  </span>
                  <small class="text-muted" style="font-size: 0.75rem;">{{ items|length }} item{% if items|length != 1 %}s{% endif %}</small>
                </div>
                <strong class="text-dark" style="font-size: 0.9rem;">{{ "%.1f"|format(type_total) }}%</strong>
              </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-primary">
            <i class="bi bi-check-lg me-1"></i>Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Handle midterm structure toggle
  const componentType = document.getElementById('componentType');
  const midtermStructureDiv = document.getElementById('midtermStructureDiv');
  const quantityDiv = document.getElementById('quantityDiv');
  const quantityInput = document.getElementById('quantityInput');
  const weightDiv = document.getElementById('weightDiv');
  const weightInput = document.getElementById('weightInput');
  const splitWeightsDiv = document.getElementById('splitWeightsDiv');
  const practicalWeight = document.getElementById('practicalWeight');
  const theoreticalWeight = document.getElementById('theoreticalWeight');

  componentType.addEventListener('change', function() {
    if (this.value === 'midterm') {
      midtermStructureDiv.style.display = 'block';
      // Check current structure
      const isSplit = document.querySelector('input[name="midterm_structure"]:checked').value === 'split';
      quantityDiv.style.display = isSplit ? 'none' : 'block';
      quantityInput.required = !isSplit;
      weightDiv.style.display = isSplit ? 'none' : 'block';
      weightInput.required = !isSplit;
      splitWeightsDiv.style.display = isSplit ? 'block' : 'none';
      practicalWeight.required = isSplit;
      theoreticalWeight.required = isSplit;
    } else {
      midtermStructureDiv.style.display = 'none';
      quantityDiv.style.display = 'block';
      quantityInput.required = true;
      weightDiv.style.display = 'block';
      weightInput.required = true;
      splitWeightsDiv.style.display = 'none';
      practicalWeight.required = false;
      theoreticalWeight.required = false;
    }
  });

  // Toggle quantity based on midterm structure
  document.querySelectorAll('input[name="midterm_structure"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      if (this.value === 'split') {
        quantityDiv.style.display = 'none';
        quantityInput.required = false;
        quantityInput.value = 1;
        weightDiv.style.display = 'none';
        weightInput.required = false;
        splitWeightsDiv.style.display = 'block';
        practicalWeight.required = true;
        theoreticalWeight.required = true;
      } else {
        quantityDiv.style.display = 'block';
        quantityInput.required = true;
        weightDiv.style.display = 'block';
        weightInput.required = true;
        splitWeightsDiv.style.display = 'none';
        practicalWeight.required = false;
        theoreticalWeight.required = false;
      }
    });
  });

  // Handle edit modal
  document.querySelectorAll('.edit-comp-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var subjectId = '{{ subject.id }}';
      var compId = this.dataset.id;
      document.getElementById('editComponentForm').action =
        '/admin/subjects/' + subjectId + '/grading/' + compId + '/edit';
      document.getElementById('editCompType').value = this.dataset.type;
      document.getElementById('editCompName').value = this.dataset.name;
      document.getElementById('editCompMax').value = this.dataset.max;
      document.getElementById('editCompWeight').value = this.dataset.weight;
      document.getElementById('editCompOrder').value = this.dataset.order;
      new bootstrap.Modal(document.getElementById('editComponentModal')).show();
    });
  });
  
  // Handle category edit modal
  document.querySelectorAll('.edit-category-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var subjectId = '{{ subject.id }}';
      var categoryType = this.dataset.type;
      var currentWeight = this.dataset.weight;
      
      // Set form action
      document.getElementById('editCategoryForm').action =
        '/admin/subjects/' + subjectId + '/grading/edit-category/' + categoryType;
      
      // Populate modal fields
      document.getElementById('categoryTypeLabel').textContent = 
        categoryType === 'lab_report' ? 'Lab Report' : categoryType.charAt(0).toUpperCase() + categoryType.slice(1);
      document.getElementById('categoryCurrentWeight').value = currentWeight + '%';
      document.getElementById('categoryNewWeight').value = currentWeight;
      
      // Show modal
      new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
    });
  });
  
  // Drag and drop functionality for category reordering
  let draggedItem = null;
  
  document.querySelectorAll('.category-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      draggedItem = this;
      this.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
      console.log('Drag started:', this.dataset.type);
    });
    
    item.addEventListener('dragend', function(e) {
      this.style.opacity = '1';
      // Remove all drag-over highlighting
      document.querySelectorAll('.category-item').forEach(function(i) {
        i.classList.remove('border-primary', 'bg-light');
      });
      console.log('Drag ended');
      // Print current order after drag
      const items = document.querySelectorAll('.category-item');
      const currentOrder = Array.from(items).map(item => item.dataset.type);
      console.log('Current DOM order after drag:', currentOrder);
    });
    
    item.addEventListener('dragover', function(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      
      // Add visual feedback
      this.classList.add('border-primary', 'bg-light');
      
      return false;
    });
    
    item.addEventListener('dragleave', function(e) {
      this.classList.remove('border-primary', 'bg-light');
    });
    
    item.addEventListener('drop', function(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      console.log('Drop on:', this.dataset.type);
      
      if (draggedItem !== this) {
        // Get container
        const container = this.parentNode;
        // Get all items
        const allItems = [...container.children];
        const draggedIndex = allItems.indexOf(draggedItem);
        const targetIndex = allItems.indexOf(this);
        
        console.log('Moving from index', draggedIndex, 'to', targetIndex);
        
        // Move the element
        if (draggedIndex < targetIndex) {
          this.parentNode.insertBefore(draggedItem, this.nextSibling);
        } else {
          this.parentNode.insertBefore(draggedItem, this);
        }
        
        // Print order after DOM manipulation
        const items = container.querySelectorAll('.category-item');
        const newOrder = Array.from(items).map(item => item.dataset.type);
        console.log('New DOM order after insert:', newOrder);
      }
      
      this.classList.remove('border-primary', 'bg-light');
      return false;
    });
  });
  
  // When form is submitted, collect the category order
  document.getElementById('reorderForm').addEventListener('submit', function(e) {
    const categoryList = document.getElementById('categoryList');
    const items = categoryList.querySelectorAll('.category-item');
    const order = Array.from(items).map(item => item.dataset.type);
    console.log('Submitting category order:', order);
    document.getElementById('categoryOrderInput').value = order.join(',');
    console.log('Hidden input value:', document.getElementById('categoryOrderInput').value);
  });
</script>
{% endblock %}
