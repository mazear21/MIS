{% extends 'base.html' %} {% block title %}Manage Teachers - MIS System{% endblock %} {% block
content %}
<div class="container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <h2><i class="bi bi-person-badge me-2"></i>Faculty Management</h2>
        <p class="text-muted mb-0">Manage teaching staff and subject assignments</p>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('admin_add_user') }}" class="btn btn-primary">
          <i class="bi bi-person-plus me-1"></i>Add Teacher
        </a>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card border-0 bg-light">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle p-3 me-3" style="background: #0000ff;">
              <i class="bi bi-people text-white" style="font-size: 1.5rem"></i>
            </div>
            <div>
              <h3 class="mb-0">{{ teachers | length }}</h3>
              <small class="text-muted">Total Teachers</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 bg-light">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle p-3 me-3" style="background: #c9a962;">
              <i class="bi bi-check-circle text-white" style="font-size: 1.5rem"></i>
            </div>
            <div>
              <h3 class="mb-0">{{ teachers | selectattr('subjects') | list | length }}</h3>
              <small class="text-muted">With Assignments</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 bg-light">
        <div class="card-body py-3">
          <div class="d-flex align-items-center">
            <div class="rounded-circle p-3 me-3" style="background: #5a8ac4;">
              <i class="bi bi-exclamation-circle text-white" style="font-size: 1.5rem"></i>
            </div>
            <div>
              <h3 class="mb-0">{{ teachers | rejectattr('subjects') | list | length }}</h3>
              <small class="text-muted">No Assignments</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Teachers Table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><i class="bi bi-table me-2"></i>Teaching Staff</span>
      <input
        type="text"
        id="searchInput"
        class="form-control form-control-sm"
        style="width: 250px"
        placeholder="Search teachers..."
      />
    </div>
    <div class="card-body p-0">
      {% if teachers %}
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="teachersTable">
          <thead class="table-light">
            <tr>
              <th style="width: 50px">#</th>
              <th>Teacher</th>
              <th>Department</th>
              <th>Contact</th>
              <th class="text-center">Subjects</th>
              <th class="text-center" style="width: 120px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for teacher in teachers %}
            <tr
              class="teacher-row"
              style="cursor: pointer"
              data-teacher-id="{{ teacher.teacher_id }}"
              data-teacher-name="{{ teacher.full_name }}"
              data-teacher-username="{{ teacher.username }}"
              data-teacher-email="{{ teacher.email or '' }}"
              data-teacher-phone="{{ teacher.phone or '' }}"
              data-teacher-department="{{ teacher.department or '' }}"
              data-teacher-key="{{ loop.index }}"
            >
              <td class="text-muted">{{ loop.index }}</td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-circle me-3">{{ teacher.full_name[0] | upper }}</div>
                  <div>
                    <strong>{{ teacher.full_name }}</strong>
                    <br /><small class="text-muted">@{{ teacher.username }}</small>
                  </div>
                </div>
              </td>
              <td>
                {% if teacher.department %}
                <span class="badge bg-light text-dark">{{ teacher.department }}</span>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if teacher.email %}
                <small><i class="bi bi-envelope me-1"></i>{{ teacher.email }}</small><br />
                {% endif %} {% if teacher.phone %}
                <small><i class="bi bi-telephone me-1"></i>{{ teacher.phone }}</small>
                {% endif %} {% if not teacher.email and not teacher.phone %}
                <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% set unique_subject_names = teacher.subjects | map(attribute='name') | list |
                unique | list %} {% if unique_subject_names | length > 0 %}
                <span
                  class="badge bg-success fs-6"
                  title="{{ unique_subject_names | length }} subjects in {{ teacher.subjects | length }} classes"
                  >{{ unique_subject_names | length }}</span
                >
                {% else %}
                <span class="badge bg-warning text-dark">0</span>
                {% endif %}
              </td>
              <td class="text-center">
                <button
                  class="btn btn-sm btn-outline-primary view-teacher-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#teacherModal"
                  title="View Details"
                >
                  <i class="bi bi-eye"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-person-badge text-muted" style="font-size: 4rem"></i>
        <h5 class="mt-3">No Teachers Found</h5>
        <p class="text-muted">Add teachers by creating users with the "Teacher" role.</p>
        <a href="{{ url_for('admin_add_user') }}" class="btn btn-primary">
          <i class="bi bi-person-plus me-1"></i>Add Teacher
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Teacher Detail Modal -->
<div class="modal fade" id="teacherModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header text-white" style="background: #0000ff;">
        <div>
          <h5 class="modal-title mb-0" id="modalTeacherName">Teacher</h5>
          <small class="opacity-75" id="modalContact"></small>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <!-- Stats Row -->
        <div class="row g-0 text-center border-bottom bg-light">
          <div class="col-3 py-3 border-end">
            <div class="fs-4 fw-bold text-dark" id="statSubjects">0</div>
            <small class="text-muted">Subjects</small>
          </div>
          <div class="col-3 py-3 border-end">
            <div class="fs-4 fw-bold text-dark" id="statClasses">0</div>
            <small class="text-muted">Classes</small>
          </div>
          <div class="col-3 py-3 border-end">
            <div class="fs-4 fw-bold text-dark" id="statMorning">0</div>
            <small class="text-muted">Morning</small>
          </div>
          <div class="col-3 py-3">
            <div class="fs-4 fw-bold text-dark" id="statNight">0</div>
            <small class="text-muted">Night</small>
          </div>
        </div>

        <div class="row g-0">
          <!-- Left: Assign Form (Collapsible) -->
          <div class="col-md-5 border-end bg-light">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
              <h6 class="fw-bold mb-0">Assign New Subject</h6>
              <button
                class="btn btn-sm btn-dark"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#assignForm"
              >
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
            <div class="collapse" id="assignForm">
              <div class="p-3">
                <form id="quickAssignForm" method="POST">
                  <input type="hidden" name="teacher_id" id="assignTeacherId" />

                  <div class="mb-3">
                    <label class="form-label small text-muted mb-1">Shift</label>
                    <div class="btn-group w-100" role="group">
                      <input
                        type="radio"
                        class="btn-check"
                        name="shiftFilter"
                        id="filterMorning"
                        value="morning"
                        checked
                      />
                      <label class="btn btn-outline-dark" for="filterMorning">Morning</label>
                      <input
                        type="radio"
                        class="btn-check"
                        name="shiftFilter"
                        id="filterNight"
                        value="night"
                      />
                      <label class="btn btn-outline-dark" for="filterNight">Evening</label>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label small text-muted mb-1">Subject</label>
                    <select name="subject_name" id="subjectSelect" class="form-select" required>
                      <option value="" data-year="">Select subject...</option>
                      <optgroup label="Year 1 - Semester 1">
                        {% for subj in unique_subjects %}{% if subj.semester == 1 %}
                        <option value="{{ subj.name }}" data-year="1">{{ subj.name }}</option>
                        {% endif %}{% endfor %}
                      </optgroup>
                      <optgroup label="Year 1 - Semester 2">
                        {% for subj in unique_subjects %}{% if subj.semester == 2 %}
                        <option value="{{ subj.name }}" data-year="1">{{ subj.name }}</option>
                        {% endif %}{% endfor %}
                      </optgroup>
                      <optgroup label="Year 2 - Semester 3">
                        {% for subj in unique_subjects %}{% if subj.semester == 3 %}
                        <option value="{{ subj.name }}" data-year="2">{{ subj.name }}</option>
                        {% endif %}{% endfor %}
                      </optgroup>
                      <optgroup label="Year 2 - Semester 4">
                        {% for subj in unique_subjects %}{% if subj.semester == 4 %}
                        <option value="{{ subj.name }}" data-year="2">{{ subj.name }}</option>
                        {% endif %}{% endfor %}
                      </optgroup>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label small text-muted mb-1">Classes</label>
                    <div
                      id="classCheckboxes"
                      class="bg-white border rounded p-2"
                      style="min-height: 42px"
                    >
                      <span class="text-muted small">Select a subject first</span>
                    </div>
                  </div>

                  <button type="submit" class="btn btn-dark w-100">
                    <i class="bi bi-check-lg me-1"></i>Assign
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- Right: Current Assignments -->
          <div class="col-md-7 p-3">
            <h6 class="fw-bold mb-3">Current Assignments</h6>
            <div id="subjectsList" style="max-height: 320px; overflow-y: auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Store subjects data -->
<script id="teachersData" type="application/json">
  {
    {% for teacher in teachers %}
    "{{ loop.index }}": {{ teacher.subjects | tojson }}{% if not loop.last %},{% endif %}
    {% endfor %}
  }
</script>

<!-- Store classes data for filtering -->
<script id="classesData" type="application/json">
  [
    {% for cls in classes %}
    {"id": {{ cls.id }}, "name": "{{ cls.name }}", "section": "{{ cls.section }}", "year": {{ cls.year }}, "semester": {{ cls.semester }}, "shift": "{{ cls.shift }}"}{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
</script>

<style>
  .avatar-circle {
    width: 40px;
    height: 40px;
    background: #0000ff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1rem;
  }
  .teacher-row:hover {
    background-color: #f4f8fc;
  }
  .teacher-row td {
    vertical-align: middle;
  }
  #teacherModal .modal-content {
    border-radius: 10px;
    overflow: hidden;
  }
  #teacherModal .card {
    border: 1px solid #d1e0f0;
  }
  #teacherModal .card-header {
    border-bottom: 1px solid #d1e0f0;
  }
  #teacherModal .table tr:last-child td {
    border-bottom: none;
  }
  #teacherModal .form-check-input:checked {
    background-color: #0000ff;
    border-color: #0000ff;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('teacherModal');
    const teachersDataEl = document.getElementById('teachersData');
    const classesDataEl = document.getElementById('classesData');
    let teachersData = {};
    let classesData = [];

    if (teachersDataEl) {
      try {
        teachersData = JSON.parse(teachersDataEl.textContent);
      } catch (e) {}
    }
    if (classesDataEl) {
      try {
        classesData = JSON.parse(classesDataEl.textContent);
      } catch (e) {}
    }

    // Update class checkboxes based on subject and shift
    function updateClassCheckboxes() {
      const shiftFilter = document.querySelector('input[name="shiftFilter"]:checked');
      const subjectSelect = document.getElementById('subjectSelect');
      const checkboxContainer = document.getElementById('classCheckboxes');
      const selectedShift = shiftFilter ? shiftFilter.value : 'morning';
      const selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
      const selectedYear = selectedOption ? selectedOption.dataset.year : '';

      if (!selectedYear) {
        checkboxContainer.innerHTML =
          '<span class="text-muted small">Select a subject first</span>';
        return;
      }

      // Filter classes by shift AND year
      const filteredClasses = classesData.filter(
        (cls) => cls.shift === selectedShift && cls.year === parseInt(selectedYear)
      );

      // Get unique sections
      const sections = [...new Set(filteredClasses.map((c) => c.section))].sort();

      let html = '<div class="d-flex gap-3">';
      sections.forEach((section) => {
        const cls = filteredClasses.find((c) => c.section === section);
        html += `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="class_ids" value="${cls.id}" id="cls${cls.id}">
            <label class="form-check-label" for="cls${cls.id}">Class ${section}</label>
          </div>
        `;
      });
      html += '</div>';

      if (sections.length === 0) {
        html = '<span class="text-muted small">No classes available for this selection</span>';
      }

      checkboxContainer.innerHTML = html;
    }

    // Bind events
    document.querySelectorAll('input[name="shiftFilter"]').forEach((radio) => {
      radio.addEventListener('change', updateClassCheckboxes);
    });
    document.getElementById('subjectSelect').addEventListener('change', updateClassCheckboxes);

    // Search
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        document.querySelectorAll('#teachersTable tbody tr').forEach((row) => {
          row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
        });
      });
    }

    // Modal
    modal.addEventListener('show.bs.modal', function (event) {
      const row = event.relatedTarget.closest('.teacher-row');
      const teacherId = row.dataset.teacherId;
      const teacherKey = row.dataset.teacherKey;
      const email = row.dataset.teacherEmail;
      const phone = row.dataset.teacherPhone;

      document.getElementById('modalTeacherName').textContent = row.dataset.teacherName;
      document.getElementById('modalContact').innerHTML =
        (email ? '<i class="bi bi-envelope me-1"></i>' + email : '') +
        (email && phone ? ' &nbsp;|&nbsp; ' : '') +
        (phone ? '<i class="bi bi-telephone me-1"></i>' + phone : '');
      document.getElementById('assignTeacherId').value = teacherId;
      document.getElementById('quickAssignForm').action =
        '/admin/teachers/' + teacherId + '/assign-subject';

      // Reset form
      document.getElementById('filterMorning').checked = true;
      document.getElementById('subjectSelect').value = '';
      document.getElementById('classCheckboxes').innerHTML =
        '<span class="text-muted small">Select a subject first</span>';

      // Get subjects and calculate stats
      const subjects = teachersData[teacherKey] || [];
      const uniqueNames = [...new Set(subjects.map((s) => s.name))];
      const morningCount = subjects.filter((s) => s.shift === 'morning').length;
      const nightCount = subjects.filter((s) => s.shift === 'night').length;

      document.getElementById('statSubjects').textContent = uniqueNames.length;
      document.getElementById('statClasses').textContent = subjects.length;
      document.getElementById('statMorning').textContent = morningCount;
      document.getElementById('statNight').textContent = nightCount;

      // Group subjects by name
      const grouped = {};
      subjects.forEach((sub) => {
        if (!grouped[sub.name]) grouped[sub.name] = [];
        grouped[sub.name].push(sub);
      });

      // Build subjects list - horizontal classes per subject
      let html = '';
      if (Object.keys(grouped).length > 0) {
        Object.keys(grouped)
          .sort()
          .forEach((name) => {
            const classes = grouped[name];
            html += `
          <div class="mb-3 pb-3 border-bottom">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <strong>${name}</strong>
              <span class="badge bg-secondary">${classes.length}</span>
            </div>
            <div class="d-flex flex-wrap gap-2">`;
            classes.forEach((c) => {
              const shiftLabel = c.shift === 'morning' ? 'Morning' : 'Evening';
              html += `
              <div class="d-inline-flex align-items-center bg-light border rounded px-2 py-1">
                <span class="small">Year ${c.year} - ${c.section} - ${shiftLabel}</span>
                <form action="/admin/teachers/unassign-subject/${c.id}" method="POST" class="d-inline ms-2" onsubmit="return confirm('Remove?');">
                  <button type="submit" class="btn btn-link btn-sm text-danger p-0 lh-1"><i class="bi bi-x"></i></button>
                </form>
              </div>`;
            });
            html += `
            </div>
          </div>`;
          });
      }

      if (!html) {
        html =
          '<div class="text-center text-muted py-4"><p class="mb-0">No subjects assigned</p></div>';
      }

      document.getElementById('subjectsList').innerHTML = html;

      // Collapse form on open
      const assignForm = document.getElementById('assignForm');
      if (assignForm.classList.contains('show')) {
        new bootstrap.Collapse(assignForm, { toggle: true });
      }
    });
  });
</script>
{% endblock %}
